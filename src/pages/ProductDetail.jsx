import { useEffect, useState } from "react";
import { useParams, Link } from "react-router-dom";
import { BASE_API } from "../utils/api";
import { ArrowLeft, ArrowRight, ChevronRight } from "lucide-react";
import { useCart } from "../context/CartContext";


export default function ProductDetail() {
  const { id } = useParams();
  const [product, setProduct] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [activeImage, setActiveImage] = useState(0);
  const [quantity, setQuantity] = useState(1);
  const [added, setAdded] = useState(false);

  const { addToCart } = useCart();


  useEffect(() => {
    const fetchProduct = async () => {
      try {
        const res = await fetch(`${BASE_API}/product/${id}`);
        if (!res.ok) throw new Error("Failed to load product");
        const data = await res.json();
        setProduct(data);
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };

    fetchProduct();
  }, [id]);

  if (loading) {
    return (
      <div className="p-10 text-center text-gray-600">Loading product...</div>
    );
  }

  if (error || !product) {
    return (
      <div className="p-10 text-center text-red-600 font-medium">
        Product not found
      </div>
    );
  }


  const getCart = () => {
  try {
    return JSON.parse(localStorage.getItem("cart")) || [];
  } catch {
    return [];
  }
};

const saveCart = (cart) => {
  localStorage.setItem("cart", JSON.stringify(cart));
};
const handleAddToCart = () => {
  const cart = getCart();

  const existingItem = cart.find((item) => item.id === product.id);

  if (existingItem) {
    existingItem.quantity += quantity;
  } else {
    cart.push({
      id: product.id,
      name: product.name,
      price: product.salePrice,
      image: product.imageOne,
      brand: product.brand?.name,
      model: product.model?.name,
      quantity,
    });
  }

  saveCart(cart);

};

  const images = [
    product.imageOne,
    product.imageTwo,
    product.imageThree,
    product.imageFour,
  ].filter(Boolean);

  return (
    <>
      <div className="bg-[#f9c821] border-b border-gray-200 sticky top-40 z-10 mb-6 hidden md:block">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between text-sm ">
          <nav className="flex items-center gap-1.5 text-white">
            <Link to="/" className="hover:text-black">
              Home
            </Link>
            <ChevronRight size={14} />
            <Link to="/shop" className="hover:text-black">
              Shop
            </Link>
            <ChevronRight size={14} />
            <span className="font-medium text-text-white">{product.name}</span>
          </nav>
        </div>
      </div>
      <div className="max-w-7xl mx-auto  py-8 md:py-12 px-8 md:px-0 mt-10">
        {/* Breadcrumb */}

        <div className="grid grid-cols-1 md:grid-cols-[1.2fr_0.8fr] gap-10 ">
          {/* Left - Image (large, prominent) */}
          <div className=" w-100 mx-auto md:w-full md:mx-0 ">
            {/* Main Image */}
            <div className="relative bg-gray-50 rounded-2xl overflow-hidden shadow-lg">
              <img
                src={`https://ecou1bc3kziqxgke.public.blob.vercel-storage.com/products/${images[activeImage]}`}
                alt={product.name}
                className="w-full h-[350px] md:h-[580px] lg:h-[650px] lg:object-cover transition-all duration-300"
              />

              {/* Prev */}
              {images.length > 1 && (
                <button
                  onClick={() =>
                    setActiveImage((prev) =>
                      prev === 0 ? images.length - 1 : prev - 1
                    )
                  }
                  className="absolute left-3 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white p-2 rounded-full shadow"
                >
                  <ArrowLeft />
                </button>
              )}

              {/* Next */}
              {images.length > 1 && (
                <button
                  onClick={() =>
                    setActiveImage((prev) =>
                      prev === images.length - 1 ? 0 : prev + 1
                    )
                  }
                  className="absolute right-3 top-1/2 -translate-y-1/2 bg-white/90 hover:bg-white p-2 rounded-full shadow"
                >
                  <ArrowRight />
                </button>
              )}
            </div>

            {/* Thumbnails */}
            {images.length > 1 && (
              <div className="flex gap-3 mt-4 justify-center">
                {images.map((img, index) => (
                  <button
                    key={index}
                    onClick={() => setActiveImage(index)}
                    className={`border-2 rounded-lg overflow-hidden w-20 h-20 ${
                      activeImage === index
                        ? "border-[#f9c821]"
                        : "border-transparent"
                    }`}
                  >
                    <img
                      src={`https://ecou1bc3kziqxgke.public.blob.vercel-storage.com/products/${img}`}
                      alt=""
                      className="w-full h-full object-cover"
                    />
                  </button>
                ))}
              </div>
            )}
          </div>

          {/* Right - Details */}
          <div className="flex flex-col w-full">
            <h1 className="text-3xl md:text-4xl font-bold mb-2">
              {product.name}
            </h1>

            {/* Rating & Reviews */}
            <div className="flex items-center gap-2 mb-1">
              <div className="flex text-yellow-400 text-xl">
                ★★★★★ <span className="text-gray-400 ml-1">(0)</span>
              </div>
              <span className="text-gray-500 text-sm">
                (0 customer reviews)
              </span>
            </div>

            {/* Supplier */}
            <p className="text-gray-600 mb-6">
              Supplied and Shipped by{" "}
              <span className="font-medium">Club Pro</span>
            </p>

            {/* Price - assuming you have salePrice / regularPrice */}
            <div className="mb-8">
              <span className="text-4xl md:text-5xl font-bold text-[#f9c821]">
                $ {product.salePrice?.toLocaleString() || "??,???"}
              </span>
              {product.regularPrice &&
                product.salePrice < product.regularPrice && (
                  <span className="ml-4 text-xl text-gray-500 line-through">
                    $ {product.regularPrice.toLocaleString()}
                  </span>
                )}
            </div>

            {/* Order Button */}
            <div className="flex items-center gap-4 mb-6">
              <span className="font-medium">Quantity</span>

              <div className="flex items-center border rounded-lg overflow-hidden">
                <button
                  onClick={() => setQuantity((q) => Math.max(1, q - 1))}
                  className="px-4 py-2 text-lg hover:bg-gray-100"
                >
                  −
                </button>

                <span className="px-5 font-medium">{quantity}</span>

                <button
                  onClick={() => setQuantity((q) => q + 1)}
                  className="px-4 py-2 text-lg hover:bg-gray-100"
                >
                  +
                </button>
              </div>
            </div>

            {/* Add to Cart */}
            <button
              onClick={() => {
                  setAdded(true);

                setTimeout(() => setAdded(false), 2000);

                  addToCart({
                    id: product.id,
                    name: product.name,
                    price: product.salePrice,
                    image: `https://ecou1bc3kziqxgke.public.blob.vercel-storage.com/products/${images[0]}`,
                    
                  })
                }
                }
              className={`w-full py-5 text-xl font-bold rounded-xl transition shadow-lg ${
                added
                  ? "bg-green-500 text-white"
                  : "bg-[#f9c821] hover:bg-yellow-500 text-white"
              }`}
            >
              {added ? "Added to Cart ✓" : "Add to Cart"}
            </button>

            {/* Optional bottom info */}
            <div className="mt-8 text-sm text-gray-500">
              <p>Brand: {product.brand.name}</p>
              <p className="mt-1">Model: {product.model.name}</p>
              <p className="mt-1">Product Type: {product.productType.name}</p>

              {/* Share icons - you can use react-icons or SVGs */}
             
            </div>
          </div>
        </div>
      </div>
    </>
  );
}
